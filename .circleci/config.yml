version: 2
general:
  branches:
    only:
      - dev
      - staging
      - prod
jobs:
  build:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - run:
          name: Deploy
          command: |
            # 1- Install AWS CLI
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
            unzip awscli-bundle.zip
            ./awscli-bundle/install -b ~/bin/aws
            # 2- Get the public IP of the current CircleCI runner
            PUBLIC_IP=$(curl ipinfo.io/ip)
            # 3- Get AWS Region
            # TODO Don't forget to replcae by your own Region
            AWS_REGION=eu-central-1
            export AWS_ACCESS_KEY_ID=$ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$SECRET_ACCESS_KEY
            # 4- Get SG ID
            # TODO Don't forget to replace by your own SG ID
            SG_ID=sg-0e8a374749084d4d1
            # 5- Add an ingress rule to the security group
            ~/bin/aws ec2 authorize-security-group-ingress --region $AWS_REGION --group-id $SG_ID \
              --protocol tcp --port 443 --cidr $PUBLIC_IP/24
